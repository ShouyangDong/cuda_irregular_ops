__mlu_global__ void softmax(float *A, float *output) {
  __nram__ float dest[25];
  __nram__ float dinominator[25];
  __nram__ float dinominator_temp[25];
  __nram__ float src1[25];
  __nram__ float addition[25];

  for (int i = clusterId * 4 + coreId; i < 45; i += 16) {
    __memcpy(src1, A + i * 25, 25 * sizeof(float), GDRAM2NRAM);
    __bang_active_exp(src1, src1, 25);
    __bang_write_zero(dinominator, 25);
    __bang_sumpool(dinominator, src1, 1, 1, 25, 1, 25, 1, 1);
    __memset_nram(dinominator_temp, 25, dinominator[0]);
    __bang_active_recip(dinominator_temp, dinominator_temp, 25);
    __bang_mul(dest, src1, dinominator_temp, 25);
    __memcpy(output + 25 * i, dest, 25 * sizeof(float), NRAM2GDRAM);
  }
}

extern "C" void softmax_kernel(float *C, float *A, int size1, int size2) {
  float *d_A;
  float *d_C;
  cnrtQueue_t queue;
  CNRT_CHECK(cnrtSetDevice(0));
  CNRT_CHECK(cnrtQueueCreate(&queue));
  cnrtMalloc((void **)(&d_A), size1 * size2 * sizeof(float));
  cnrtMalloc((void **)(&d_C), size1 * size2 * sizeof(float));

  cnrtMemcpy(d_A, A, size1 * size2 * sizeof(float), cnrtMemcpyHostToDev);

  cnrtDim3_t dim = {16, 1, 1};
  cnrtFunctionType_t ktype = CNRT_FUNC_TYPE_UNION4;

  softmax<<<dim, ktype, queue>>>(d_A, d_C);
  cnrtQueueSync(queue);
  cnrtMemcpy(C, d_C, size1 * size2 * sizeof(float), cnrtMemcpyDevToHost);
  cnrtQueueDestroy(queue);

  cnrtFree(d_A);
  cnrtFree(d_C);
}